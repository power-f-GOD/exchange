<!-- 
  Chart sample pulled from Svelte's Area Chart sample @ https://svelte.dev/examples/area-chart 
-->
<script lang="ts">
  /** internal deps */
  import { A_DAY_IN_MS, A_SEC_IN_MS } from '../../constants';
  import type { StreamResponseData } from '../../types';
  import { samplePoints } from '../../socket';
  import Stack from './Stack.svelte';

  /** props */
  export let width = 240;
  export let height = 55;
  export let data: Partial<StreamResponseData>[] = [];

  /** react-ibles */
  $: points = data.length ? data : samplePoints;
  $: firstTick = points[0];
  $: lastTick = points?.slice(-1)[0];
  $: maxX = (+firstTick.C! - +firstTick.O!) / A_SEC_IN_MS;
  $: maxY = +(+firstTick.h! - +firstTick.l!).toFixed(2);
  $: computeX = (ticker: Partial<StreamResponseData>) =>
    +Math.abs((ticker.E! - firstTick.O! - A_DAY_IN_MS) / A_SEC_IN_MS).toFixed(2);
  $: computeY = (ticker: Partial<StreamResponseData>) =>
    +Math.abs(((+maxY - (+ticker.a! - +firstTick.l!)) / maxY) * height).toFixed(1);
  $: path = `M${computeX(firstTick)},${computeY(firstTick)}L${points
    .map((ticker) => {
      const x = computeX(ticker);
      let y = computeY(ticker);

      // i.e. if is sample points
      if (!firstTick.s) {
        return `${(x / maxX) * width},${y}`;
      }

      return `${x},${y}`;
    })
    .join('L')}`;
  $: area = `${path},L${+Math.abs((lastTick.E! - firstTick.O! - A_DAY_IN_MS) / A_SEC_IN_MS).toFixed(
    2
  )},${height}L0,${height}Z`;
  $: percentageNegative = lastTick?.P?.includes('-');
</script>

<Stack class="overflow-auto w-full">
  <svg style="width:{width}px; height:{height}px" class="max-h-full overflow-visible relative">
    <defs>
      <linearGradient id="gradient" gradientTransform="rotate(80)">
        <stop
          offset="0%"
          stop-color={!lastTick.s
            ? 'rgba(200, 200, 200, 0.05)'
            : `${
                !percentageNegative ? 'rgba(38, 226, 156, 0.125)' : 'rgba(245, 89, 89, 0.125)'
              }`} />
        <stop offset="100%" stop-color="white" />
      </linearGradient>
    </defs>
    <!-- data -->
    <path class="area" d={area} fill="url(#gradient)" />
    <path
      class="path-line"
      d={path}
      style={`stroke: ${
        !lastTick.s ? 'rgba(0, 0, 0, 0.075)' : percentageNegative ? '#F55959' : '#26E29C'
      }`} />
  </svg>
</Stack>

<style>
  .path-line {
    fill: none;
    stroke-linejoin: round;
    stroke-linecap: round;
    stroke-width: 0.125em;
  }
</style>
